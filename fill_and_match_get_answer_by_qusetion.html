<!DOCTYPE html>
<html lang="en">
<head>
    <title>Firebase</title>
    <meta charset="UTF-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.5.4/firebase.js"></script>
    <style>
        table {
            font-family: arial, sans-serif;
            border-collapse: collapse;
            width: 100%;
        }

        td, th {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 8px;
        }

        tr:nth-child(even) {
            background-color: #dddddd;
        }

        button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
        }
    </style>
</head>
<body>

<table>
    <tr>
        <td>mIdBlock</td>
        <td><input type="text" id="mIdBlock" size="100"></td>
    </tr>

    <tr>
        <td>mIdType</td>
        <td><input type="text" id="mIdType" size="100"></td>
    </tr>

    <tr>
        <td>mIdLevel</td>
        <td><input type="text" id="mIdLevel" size="100"></td>
    </tr>

    <tr>
        <td>mExtent</td>
        <td><input type="text" id="mExtent" size="100"></td>
    </tr>
</table>

<center><br>
    <button onclick="filter()" style="width: 50%">FILTER</button>
    <br><br></center>

<table style="width:100%" id="ex-table">
    <!--<tr id="tr">-->
        <!--<th>idQuestion</th>-->
        <!--<th>contentQuestion</th>-->
        <!--<th>idAnswer</th>-->
        <!--<th>contentAnswer</th>-->
</table>

<script>
    let config = {
        apiKey: "AIzaSyAX_MCy_DNcww2hF7S8mepc17Z0_TeLE10",
        authDomain: "luanvantotnghiep-3d890.firebaseapp.com",
        databaseURL: "https://luanvantotnghiep-3d890.firebaseio.com",
        projectId: "luanvantotnghiep-3d890",
        storageBucket: "luanvantotnghiep-3d890.appspot.com",
        messagingSenderId: "470187573210"
    };
    firebase.initializeApp(config);

    let myRefQUESTION = firebase.database().ref().child('QUESTION');
    let myRefABQ = firebase.database().ref().child('ANSWER_BY_QUESTION');
    let myRefANSWER = firebase.database().ref().child('ANSWER');

    let questionList = [];
    let answerByQuestionList = [];
    let answerList = [];

    myRefQUESTION.once('value', function (snapshot) {
        snapshot.forEach(function (childSnapshot) {
            let question = childSnapshot.val();
            questionList.push(question);
        });
        loadAnswerByQuestion();
    });

    function loadAnswerByQuestion() {
        myRefABQ.once('value', function (snapshot) {
            snapshot.forEach(function (childSnapshot) {
                let answerByQuestion = childSnapshot.val();
                answerByQuestionList.push(answerByQuestion);
            });
            loadAnswer()
        });
    }

    function loadAnswer() {
        myRefANSWER.once('value', function (snapshot) {
            snapshot.forEach(function (childSnapshot) {
                let answerByQuestion = childSnapshot.val();
                answerList.push(answerByQuestion);
            });
            confirm("Load xong!!!");
        });
    }

    function filter() {

        let mIdBlock = document.getElementById("mIdBlock").value;
        let mIdType = document.getElementById("mIdType").value;
        let mIdLevel = document.getElementById("mIdLevel").value;
        let mExtent = document.getElementById("mExtent").value;

        //handle listTemp
        let listTemp = [];
        for (let i = 0; i < questionList.length; i++) {
            let question = questionList[i];
            if (question.idBlock === parseInt(mIdBlock)
                && question.idType === parseInt(mIdType)
                && question.idLevel === parseInt(mIdLevel)
                && question.extent === parseInt(mExtent)) {
                listTemp.push(question);
            }
        }

        $('#ex-table').empty();
        console.log(listTemp.length);
        let table = '';
        table += '<tr>';
        table += '<th>' + 'idQuestion'+ '</th>';
        table += '<th>' + 'contentQuestion'+ '</th>';
        table += '<th>' + 'idAnswer'+ '</th>';
        table += '<th>' + 'contentAnswer'+ '</th>';
        $('#ex-table').append(table);

        for (let posi = 0; posi < listTemp.length; posi++) {
            let idQues = listTemp[posi].idQuestion;
            for (let i = 0; i < answerByQuestionList.length; i++) {
                if (idQues === answerByQuestionList[i].idQuestion) {
                    let idAnswer = answerByQuestionList[i].idAnswer;
                    for (let j = 0; j < answerList.length; j++) {
                        if (idAnswer === answerList[j].idAnswer) {
                            let content = '';
                            content += '<tr>';
                            content += '<td>' + listTemp[posi].idQuestion + '</td>';
                            content += '<td>' + listTemp[posi].contentQuestion + '</td>';
                            content += '<td>' + answerList[j].idAnswer + '</td>';
                            content += '<td>' + answerList[j].contentAnswer + '</td>';
                            content += '</tr>';
                            $('#ex-table').append(content);
                            break;
                        }
                    }
                    break;
                }
            }
        }
    }

</script>
</body>
</html>